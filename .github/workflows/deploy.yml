name: Deploy to Debian Server

on:
  push:
    branches: [ "master" ]
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy using SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASSWORD }}
          port: 22
          script_stop: true # å¦‚æœä»»ä½•å‘½ä»¤å¤±è´¥ï¼Œåœæ­¢æ‰§è¡Œ
          script: |
            # 1. è¿›å…¥é¡¹ç›®ç›®å½•
            cd ${{ secrets.PROJECT_PATH }}
            
            # 2. æ‹‰å–æœ€æ–°ä»£ç 
            echo "ğŸ”„ Pulling latest code..."
            git fetch --all
            git reset --hard origin/master
            
            # 3. æ›´æ–° Conda ç¯å¢ƒ
            # æ³¨æ„ï¼šéœ€è¦æ‰¾åˆ° conda.sh çš„ä½ç½®æ¥åœ¨éäº¤äº’å¼ shell ä¸­æ¿€æ´» conda
            # å¸¸è§çš„è·¯å¾„æ˜¯ ~/anaconda3/etc/profile.d/conda.sh æˆ– /opt/anaconda...
            echo "ğŸ Updating Conda environment..."
            source ~/anaconda3/etc/profile.d/conda.sh
            conda activate discord_music_bot
            conda env update -f environment.yml --prune
            
            # 4. é‡å¯æœåŠ¡
            echo "ğŸš€ Restarting Service..."
            # å¦‚æœä½ çš„ç”¨æˆ·ä¸æ˜¯ rootï¼Œéœ€è¦ç¡®ä¿è¯¥ç”¨æˆ·æœ‰æƒé™æ‰§è¡Œ sudo systemctl restart
            # æˆ–è€…é…ç½® visudo å…è®¸å…å¯†é‡å¯
            sudo systemctl restart discord_bot.service
            
            echo "âœ… Deployment Complete!"
